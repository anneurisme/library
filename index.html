<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Llorna's Library</title>

<style>
  body {
    margin: 0;
    background: #1e1e1e;
    font-family: system-ui, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .viewer {
    width: 95vw;
    max-width: 1200px;
    background: #111;
    border-radius: 10px;
    box-shadow: 0 20px 60px rgba(0,0,0,.5);
    overflow: hidden;
  }

  .top-bar {
    background: #181818;
    padding: 14px 20px;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .meta {
    min-width: 0;
  }

  .title {
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .author {
    color: #aaa;
    font-size: 13px;
    margin-top: 2px;
  }

  .pdf-btn {
    background: #3b82f6;
    color: #fff;
    padding: 8px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .pdf-btn:hover {
    background: #2563eb;
  }

  #flipbook {
    width: 100%;
    height: calc(100vw * 0.9);
    max-height: 700px;
    margin: 10px auto;
  }

  #flipbook .page {
    background: #fff;
  }

  #flipbook img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
</style>
</head>
<body>

<div class="viewer">
  <div class="top-bar">
    <div class="meta">
      <div class="title" id="book-title">Loadingâ€¦</div>
      <div class="author" id="book-author"></div>
    </div>

    <a id="pdf-link" class="pdf-btn" href="#" target="_blank" rel="noopener">
      View PDF
    </a>
  </div>

  <div id="flipbook"></div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Turn.js -->
<script src="https://cdn.jsdelivr.net/gh/blasten/turn.js@master/turn.min.js"></script>

<script>
const DEFAULT_BOOK = "test";
const MAX_PAGES = 50;

const params = new URLSearchParams(window.location.search);
const book = params.get("book") || DEFAULT_BOOK;

const basePath = `books/${book}/`;
const flipbookEl = document.getElementById("flipbook");

// Load metadata
fetch(basePath + "book.json")
  .then(res => {
    if (!res.ok) throw new Error("Missing book.json");
    return res.json();
  })
  .then(meta => {
    document.getElementById("book-title").textContent = meta.title || "Untitled";
    document.getElementById("book-author").textContent = meta.author || "";

    if (meta.pdfUrl) {
      document.getElementById("pdf-link").href = meta.pdfUrl;
    } else {
      document.getElementById("pdf-link").style.display = "none";
    }
  })
  .catch(() => {
    document.getElementById("book-title").textContent = "Untitled Book";
    document.getElementById("book-author").textContent = "";
    document.getElementById("pdf-link").style.display = "none";
  });

// Page loader
function loadPage(n) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = `${basePath}${n}.jpg`;
  });
}

(async function buildBook() {
  let pages = 0;

  for (let i = 1; i <= MAX_PAGES; i++) {
    try {
      const img = await loadPage(i);
      const page = document.createElement("div");
      page.className = "page";
      page.appendChild(img);
      flipbookEl.appendChild(page);
      pages++;
    } catch {
      break;
    }
  }

  if (pages < 2) {
    flipbookEl.innerHTML = `
      <div style="color:white;text-align:center;padding:40px">
        Need at least 2 pages to flip.<br/>
        Check <b>2.jpg</b> exists in <code>${basePath}</code>.
      </div>`;
    return;
  }

  $("#flipbook").turn({
    width: flipbookEl.clientWidth,
    height: flipbookEl.clientHeight,
    autoCenter: true,
    gradients: true,
    elevation: 50
  });

  // Click left/right to navigate
  $("#flipbook").on("click", function (e) {
    const rect = this.getBoundingClientRect();
    const x = e.clientX - rect.left;

    if (x < rect.width / 2) {
      $(this).turn("previous");
    } else {
      $(this).turn("next");
    }
  });

  // Keyboard navigation
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowRight") $("#flipbook").turn("next");
    if (e.key === "ArrowLeft") $("#flipbook").turn("previous");
  });

  // Resize support
  window.addEventListener("resize", () => {
    $("#flipbook").turn(
      "size",
      flipbookEl.clientWidth,
      flipbookEl.clientHeight
    );
  });
})();
</script>

</body>
</html>
