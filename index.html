<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Llorna's Library</title>

<style>
  body {
    margin: 0;
    background: #1e1e1e;
    font-family: system-ui, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .viewer {
    width: 820px;
    background: #111;
    border-radius: 10px;
    box-shadow: 0 20px 60px rgba(0,0,0,.5);
    overflow: hidden;
  }

  .top-bar {
    background: #181818;
    padding: 14px 20px;
    border-bottom: 1px solid #333;
  }

  .title {
    color: #fff;
    font-size: 18px;
    font-weight: 600;
  }

  .author {
    color: #aaa;
    font-size: 13px;
    margin-top: 2px;
  }

  #flipbook {
    width: 800px;
    height: 500px;
    margin: 10px auto;
  }

  #flipbook .page {
    background: #fff;
  }

  #flipbook img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .bottom-bar {
    background: #181818;
    padding: 12px;
    border-top: 1px solid #333;
    text-align: center;
  }

  .pdf-btn {
    background: #3b82f6;
    color: #fff;
    padding: 10px 18px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    display: inline-block;
  }

  .pdf-btn:hover {
    background: #2563eb;
  }
</style>
</head>
<body>

<div class="viewer">
  <div class="top-bar">
    <div class="title" id="book-title">Loadingâ€¦</div>
    <div class="author" id="book-author"></div>
  </div>

  <div id="flipbook"></div>

  <div class="bottom-bar">
    <a id="pdf-link" class="pdf-btn" href="#" target="_blank" rel="noopener">
      View the PDF
    </a>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/blasten/turn.js@master/turn.min.js"></script>

<script>
const DEFAULT_BOOK = "test";
const MAX_PAGES = 50;

const params = new URLSearchParams(window.location.search);
const book = params.get("book") || DEFAULT_BOOK;

const basePath = `books/${book}/`;
const flipbookEl = document.getElementById("flipbook");

// Load metadata
fetch(basePath + "book.json")
  .then(res => {
    if (!res.ok) throw new Error("book.json not found");
    return res.json();
  })
  .then(meta => {
    document.getElementById("book-title").textContent = meta.title || "Untitled";
    document.getElementById("book-author").textContent = meta.author || "";

    if (meta.pdfUrl) {
      document.getElementById("pdf-link").href = meta.pdfUrl;
    } else {
      document.getElementById("pdf-link").style.display = "none";
    }
  })
  .catch(err => {
    console.warn(err);
    document.getElementById("book-title").textContent = "Untitled Book";
    document.getElementById("book-author").textContent = "";
    document.getElementById("pdf-link").style.display = "none";
  });

// Page loader
function loadPage(n) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = () => reject(new Error(`Missing: ${basePath}${n}.jpg`));
    img.src = `${basePath}${n}.jpg`;
  });
}

(async function buildBook() {
  let pages = 0;

  for (let i = 1; i <= MAX_PAGES; i++) {
    try {
      const img = await loadPage(i);

      const page = document.createElement("div");
      page.className = "page";
      page.appendChild(img);
      flipbookEl.appendChild(page);

      pages++;
    } catch (e) {
      // Stop at the first missing page
      break;
    }
  }

  // IMPORTANT: need at least 2 pages to flip
  if (pages < 2) {
    flipbookEl.innerHTML = `<div style="color:white;text-align:center;padding:40px">
      Found ${pages} page(s). Turn.js needs at least 2 pages.<br/>
      Check that <b>2.jpg</b> exists at <code>${basePath}</code> (case-sensitive).
    </div>`;
    return;
  }

  $("#flipbook").turn({
    width: 800,
    height: 500,
    autoCenter: true,
    gradients: true,
    elevation: 50
  });

  // Click anywhere to turn (simple UX)
  $("#flipbook").on("click", () => {
    $("#flipbook").turn("next");
  });

  // Keyboard support
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowRight") $("#flipbook").turn("next");
    if (e.key === "ArrowLeft") $("#flipbook").turn("previous");
  });
})();
</script>

</body>
</html>
